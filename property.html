<script>
    const urlParams = new URLSearchParams(window.location.search);
    const propertyID = urlParams.get('id');
    let property = {};

    const sections = {
        general: document.getElementById('section-general'),
        details: document.getElementById('section-details'),
        legal: document.getElementById('section-legal'),
        links: document.getElementById('section-links')
    };

    const fieldGroups = {
        general: [
            ['city', 'עיר', 'fa-city'],
            ['neighborhood', 'שכונה', 'fa-location-dot'],
            ['street', 'רחוב', 'fa-road'],
            ['houseNumber', 'מספר בית', 'fa-hashtag'],
            ['floor', 'קומה', 'fa-layer-group'],
            ['rooms', 'מספר חדרים', 'fa-bed'],
            ['propertyType', 'סוג נכס', 'fa-building']
        ],
        details: [
            ['apartmentsPerFloor', 'דירות בקומה', 'fa-building-user'],
            ['apartmentsInBuilding', 'דירות בבניין', 'fa-building-columns'],
            ['size', 'גודל הדירה כ', 'fa-ruler-combined'],
            ['balconySize', 'גודל מרפסת כ', 'fa-up-right-and-down-left-from-center'],
            ['mamad', 'ממ"ד', 'fa-shield-halved'],
            ['parking', 'חניה', 'fa-square-parking'],
            ['storage', 'מחסן', 'fa-box-archive'],
            ['Airdirection', 'כיווני אוויר', 'fa-compass'],
            ['airConditioning', 'מיזוג אוויר', 'fa-wind'],
            ['buildingExtras', 'תוספות לבניין', 'fa-building-circle-check'],
            ['waterHeating', 'חימום מים', 'fa-fire']
        ],
        legal: [
            ['yearBuilt', 'שנת בנייה', 'fa-calendar-days'],
            ['contractor', 'שם הקבלן', 'fa-user-hard-hat'],
            ['Structurewarranty', 'אחריות קבלן', 'fa-file-contract'],
            ['vaadBayit', 'ועד בית', 'fa-people-roof'],
            ['arnona', 'ארנונה', 'fa-sack-dollar'],
            ['tabu', 'טאבו', 'fa-scroll'],
            ['sellerRegistered', 'מוכר רשום', 'fa-user'],
            ['price', 'מחיר', 'fa-money-bill-wave'],
            ['description', 'תיאור', 'fa-align-right']
        ],
        links: [
            ['link', 'לינק לפרסום', 'fa-link'],
            ['full_link', 'לינק מלא', 'fa-up-right-from-square']
        ]
    };

    if (!propertyID) {
        sections.general.innerHTML = '<strong>❌ שגיאה:</strong> לא נמצא ID של הדירה!';
    } else {
        fetch(`https://sheetdb.io/api/v1/x66b7o2fa8f7k/search?id=${propertyID}`)
            .then(response => response.json())
            .then(data => {
                if (data.length === 0) {
                    sections.general.innerHTML = '<strong>❌ שגיאה:</strong> הדירה לא נמצאה!';
                } else {
                    property = data[0];
                    renderSections();
                }
            })
            .catch(error => {
                console.error('⚠️ שגיאה:', error);
                sections.general.innerHTML = '<strong>❌ שגיאה:</strong> בטעינת הנתונים!';
            });
    }

    function renderSections() {
        Object.entries(fieldGroups).forEach(([groupName, fields]) => {
            const section = sections[groupName];
            section.innerHTML = '';
            fields.forEach(([key, label, icon]) => {
                const value = property[key] || '';
                let html = '';

                if (key === 'link' || key === 'full_link') {
                    html = `<button class="link-button" onclick="window.open('${value}', '_blank')">🔗 ${label}</button>`;
                } else {
                    html = `<span id="${key}">${value}</span>`;
                }

                section.innerHTML += `
                    <div class="detail-box">
                        <div class="detail-icon"><i class="fa-solid ${icon}"></i></div>
                        <strong>${label}:</strong>&nbsp; ${html}
                    </div>`;
            });
        });
    }

    function enableEditing() {
        document.querySelectorAll('.detail-box span').forEach(span => {
            const value = span.textContent;
            const input = document.createElement('input');
            input.type = 'text';
            input.value = value;
            input.style.width = '100%';
            span.innerHTML = '';
            span.appendChild(input);
        });
        document.querySelector('.edit-button').style.display = 'none';
        document.querySelector('.save-button').style.display = 'inline-block';
    }

    function saveChanges() {
        let updatedProperty = {};
        document.querySelectorAll('.detail-box span').forEach(span => {
            if (span.querySelector('input')) {
                updatedProperty[span.id] = span.querySelector('input').value;
            }
        });

        fetch(`https://sheetdb.io/api/v1/x66b7o2fa8f7k/id/${propertyID}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updatedProperty)
        })
        .then(response => response.json())
        .then(data => {
            alert('הנתונים עודכנו בהצלחה!');
            location.reload();
        })
        .catch(error => {
            console.error('⚠️ שגיאה בשמירה:', error);
            alert('❌ לא הצלחנו לשמור את הנתונים.');
        });
    }

    function exportToWord() {
        const sectionsData = {
            "🧾 מידע כללי": document.getElementById("section-general"),
            "🏠 פרטים על הנכס": document.getElementById("section-details"),
            "📄 פרטים משפטיים וכלליים": document.getElementById("section-legal"),
            "🔗 קישורים": document.getElementById("section-links")
        };

        let wordContent = `
            <html xmlns:o='urn:schemas-microsoft-com:office:office' 
                  xmlns:w='urn:schemas-microsoft-com:office:word' 
                  xmlns='http://www.w3.org/TR/REC-html40'>
            <head><meta charset='utf-8'>
                <style>
                    body { direction: rtl; font-family: Arial, sans-serif; }
                    h2 { color: #5d3a00; border-bottom: 2px solid #ccc; padding-bottom: 5px; }
                    table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
                    th, td { border: 1px solid #ccc; padding: 8px 12px; text-align: right; }
                    th { background-color: #f0f0f0; color: #333; }
                </style>
            </head><body>
            <h1 style="text-align:center;">פרטי נכס</h1>
            <img src="https://raw.githubusercontent.com/idankru/real-estate-form/main/%D7%A9%D7%9C%D7%95%D7%92%D7%95%20%D7%97%D7%91%D7%A8%D7%94%20.jpg" alt="לוגו" style="height:80px; display:block; margin:0 auto 30px;"/>
        `;

        for (const [sectionTitle, sectionElement] of Object.entries(sectionsData)) {
            wordContent += `<h2>${sectionTitle}</h2><table><tbody>`;
            const boxes = sectionElement.querySelectorAll(".detail-box");
            boxes.forEach(box => {
                const label = box.querySelector("strong")?.textContent?.replace(":", "") || "";
                const valueEl = box.querySelector("span") || box.querySelector("button");
                const value = valueEl?.innerText || "";
                wordContent += `<tr><th>${label}</th><td>${value}</td></tr>`;
            });
            wordContent += `</tbody></table>`;
        }

        wordContent += `</body></html>`;

        const blob = new Blob(['\ufeff', wordContent], {
            type: 'application/msword'
        });

        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `פרטי_נכס_${propertyID || "חדש"}.doc`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>
