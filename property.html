<script>
    const urlParams = new URLSearchParams(window.location.search);
    const propertyID = urlParams.get('id');
    let property = {};

    const sections = {
        general: document.getElementById('section-general'),
        details: document.getElementById('section-details'),
        legal: document.getElementById('section-legal'),
        links: document.getElementById('section-links')
    };

    const fieldGroups = {
        general: [
            ['city', '×¢×™×¨', 'fa-city'],
            ['neighborhood', '×©×›×•× ×”', 'fa-location-dot'],
            ['street', '×¨×—×•×‘', 'fa-road'],
            ['houseNumber', '××¡×¤×¨ ×‘×™×ª', 'fa-hashtag'],
            ['floor', '×§×•××”', 'fa-layer-group'],
            ['rooms', '××¡×¤×¨ ×—×“×¨×™×', 'fa-bed'],
            ['propertyType', '×¡×•×’ × ×›×¡', 'fa-building']
        ],
        details: [
            ['apartmentsPerFloor', '×“×™×¨×•×ª ×‘×§×•××”', 'fa-building-user'],
            ['apartmentsInBuilding', '×“×™×¨×•×ª ×‘×‘× ×™×™×Ÿ', 'fa-building-columns'],
            ['size', '×’×•×“×œ ×”×“×™×¨×” ×›', 'fa-ruler-combined'],
            ['balconySize', '×’×•×“×œ ××¨×¤×¡×ª ×›', 'fa-up-right-and-down-left-from-center'],
            ['mamad', '××"×“', 'fa-shield-halved'],
            ['parking', '×—× ×™×”', 'fa-square-parking'],
            ['storage', '××—×¡×Ÿ', 'fa-box-archive'],
            ['Airdirection', '×›×™×•×•× ×™ ××•×•×™×¨', 'fa-compass'],
            ['airConditioning', '××™×–×•×’ ××•×•×™×¨', 'fa-wind'],
            ['buildingExtras', '×ª×•×¡×¤×•×ª ×œ×‘× ×™×™×Ÿ', 'fa-building-circle-check'],
            ['waterHeating', '×—×™××•× ××™×', 'fa-fire']
        ],
        legal: [
            ['yearBuilt', '×©× ×ª ×‘× ×™×™×”', 'fa-calendar-days'],
            ['contractor', '×©× ×”×§×‘×œ×Ÿ', 'fa-user-hard-hat'],
            ['Structurewarranty', '××—×¨×™×•×ª ×§×‘×œ×Ÿ', 'fa-file-contract'],
            ['vaadBayit', '×•×¢×“ ×‘×™×ª', 'fa-people-roof'],
            ['arnona', '××¨× ×•× ×”', 'fa-sack-dollar'],
            ['tabu', '×˜××‘×•', 'fa-scroll'],
            ['sellerRegistered', '××•×›×¨ ×¨×©×•×', 'fa-user'],
            ['price', '××—×™×¨', 'fa-money-bill-wave'],
            ['description', '×ª×™××•×¨', 'fa-align-right']
        ],
        links: [
            ['link', '×œ×™× ×§ ×œ×¤×¨×¡×•×', 'fa-link'],
            ['full_link', '×œ×™× ×§ ××œ×', 'fa-up-right-from-square']
        ]
    };

    if (!propertyID) {
        sections.general.innerHTML = '<strong>âŒ ×©×’×™××”:</strong> ×œ× × ××¦× ID ×©×œ ×”×“×™×¨×”!';
    } else {
        fetch(`https://sheetdb.io/api/v1/x66b7o2fa8f7k/search?id=${propertyID}`)
            .then(response => response.json())
            .then(data => {
                if (data.length === 0) {
                    sections.general.innerHTML = '<strong>âŒ ×©×’×™××”:</strong> ×”×“×™×¨×” ×œ× × ××¦××”!';
                } else {
                    property = data[0];
                    renderSections();
                }
            })
            .catch(error => {
                console.error('âš ï¸ ×©×’×™××”:', error);
                sections.general.innerHTML = '<strong>âŒ ×©×’×™××”:</strong> ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×!';
            });
    }

    function renderSections() {
        Object.entries(fieldGroups).forEach(([groupName, fields]) => {
            const section = sections[groupName];
            section.innerHTML = '';
            fields.forEach(([key, label, icon]) => {
                const value = property[key] || '';
                let html = '';

                if (key === 'link' || key === 'full_link') {
                    html = `<button class="link-button" onclick="window.open('${value}', '_blank')">ğŸ”— ${label}</button>`;
                } else {
                    html = `<span id="${key}">${value}</span>`;
                }

                section.innerHTML += `
                    <div class="detail-box">
                        <div class="detail-icon"><i class="fa-solid ${icon}"></i></div>
                        <strong>${label}:</strong>&nbsp; ${html}
                    </div>`;
            });
        });
    }

    function enableEditing() {
        document.querySelectorAll('.detail-box span').forEach(span => {
            const value = span.textContent;
            const input = document.createElement('input');
            input.type = 'text';
            input.value = value;
            input.style.width = '100%';
            span.innerHTML = '';
            span.appendChild(input);
        });
        document.querySelector('.edit-button').style.display = 'none';
        document.querySelector('.save-button').style.display = 'inline-block';
    }

    function saveChanges() {
        let updatedProperty = {};
        document.querySelectorAll('.detail-box span').forEach(span => {
            if (span.querySelector('input')) {
                updatedProperty[span.id] = span.querySelector('input').value;
            }
        });

        fetch(`https://sheetdb.io/api/v1/x66b7o2fa8f7k/id/${propertyID}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(updatedProperty)
        })
        .then(response => response.json())
        .then(data => {
            alert('×”× ×ª×•× ×™× ×¢×•×“×›× ×• ×‘×”×¦×œ×—×”!');
            location.reload();
        })
        .catch(error => {
            console.error('âš ï¸ ×©×’×™××” ×‘×©××™×¨×”:', error);
            alert('âŒ ×œ× ×”×¦×œ×—× ×• ×œ×©××•×¨ ××ª ×”× ×ª×•× ×™×.');
        });
    }

    function exportToWord() {
        const sectionsData = {
            "ğŸ§¾ ××™×“×¢ ×›×œ×œ×™": document.getElementById("section-general"),
            "ğŸ  ×¤×¨×˜×™× ×¢×œ ×”× ×›×¡": document.getElementById("section-details"),
            "ğŸ“„ ×¤×¨×˜×™× ××©×¤×˜×™×™× ×•×›×œ×œ×™×™×": document.getElementById("section-legal"),
            "ğŸ”— ×§×™×©×•×¨×™×": document.getElementById("section-links")
        };

        let wordContent = `
            <html xmlns:o='urn:schemas-microsoft-com:office:office' 
                  xmlns:w='urn:schemas-microsoft-com:office:word' 
                  xmlns='http://www.w3.org/TR/REC-html40'>
            <head><meta charset='utf-8'>
                <style>
                    body { direction: rtl; font-family: Arial, sans-serif; }
                    h2 { color: #5d3a00; border-bottom: 2px solid #ccc; padding-bottom: 5px; }
                    table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
                    th, td { border: 1px solid #ccc; padding: 8px 12px; text-align: right; }
                    th { background-color: #f0f0f0; color: #333; }
                </style>
            </head><body>
            <h1 style="text-align:center;">×¤×¨×˜×™ × ×›×¡</h1>
            <img src="https://raw.githubusercontent.com/idankru/real-estate-form/main/%D7%A9%D7%9C%D7%95%D7%92%D7%95%20%D7%97%D7%91%D7%A8%D7%94%20.jpg" alt="×œ×•×’×•" style="height:80px; display:block; margin:0 auto 30px;"/>
        `;

        for (const [sectionTitle, sectionElement] of Object.entries(sectionsData)) {
            wordContent += `<h2>${sectionTitle}</h2><table><tbody>`;
            const boxes = sectionElement.querySelectorAll(".detail-box");
            boxes.forEach(box => {
                const label = box.querySelector("strong")?.textContent?.replace(":", "") || "";
                const valueEl = box.querySelector("span") || box.querySelector("button");
                const value = valueEl?.innerText || "";
                wordContent += `<tr><th>${label}</th><td>${value}</td></tr>`;
            });
            wordContent += `</tbody></table>`;
        }

        wordContent += `</body></html>`;

        const blob = new Blob(['\ufeff', wordContent], {
            type: 'application/msword'
        });

        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `×¤×¨×˜×™_× ×›×¡_${propertyID || "×—×“×©"}.doc`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>
